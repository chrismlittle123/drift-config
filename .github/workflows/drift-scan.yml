# Drift Scan Workflow
# Scans all repositories for configuration drift and compliance issues

name: Drift Scan

on:
  # Weekly scan - Monday at 9am UTC
  schedule:
    - cron: "0 9 * * 1"

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      repo:
        description: "Specific repo to scan (leave empty for all)"
        required: false
        type: string

jobs:
  scan:
    name: Scan for drift
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout config repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install drift CLI
        run: npm install -g repo-drift

      - name: Run drift scan
        id: scan
        env:
          GITHUB_TOKEN: ${{ secrets.DRIFT_GITHUB_TOKEN }}
        run: |
          # Build command
          ARGS="scan --org chrismlittle123 --json"

          if [ -n "${{ inputs.repo }}" ]; then
            ARGS="$ARGS --repo ${{ inputs.repo }}"
          fi

          echo "Running: drift $ARGS"

          # Run scan and capture output
          set +e
          drift $ARGS > drift-results.json 2>&1
          EXIT_CODE=$?
          set -e

          # Parse results
          if [ -f drift-results.json ] && jq -e . drift-results.json > /dev/null 2>&1; then
            REPOS_SCANNED=$(jq -r '.summary.reposScanned // 0' drift-results.json)
            REPOS_WITH_ISSUES=$(jq -r '.summary.reposWithIssues // 0' drift-results.json)

            echo "repos_scanned=$REPOS_SCANNED" >> $GITHUB_OUTPUT
            echo "repos_with_issues=$REPOS_WITH_ISSUES" >> $GITHUB_OUTPUT
            echo "has_issues=$([[ $REPOS_WITH_ISSUES -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT

            # Pretty print summary
            echo ""
            echo "================================"
            echo "DRIFT SCAN SUMMARY"
            echo "================================"
            echo "Repos scanned: $REPOS_SCANNED"
            echo "Repos with issues: $REPOS_WITH_ISSUES"

            if [ "$REPOS_WITH_ISSUES" -gt 0 ]; then
              echo ""
              echo "Repos with issues:"
              jq -r '.repos[] | select(.results.summary.integrityFailed > 0 or .results.summary.scansFailed > 0) | "  - \(.repo)"' drift-results.json
            fi
          else
            echo "repos_scanned=0" >> $GITHUB_OUTPUT
            echo "repos_with_issues=0" >> $GITHUB_OUTPUT
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "Warning: Could not parse scan results"
            cat drift-results.json
          fi

          exit $EXIT_CODE

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-results-${{ github.run_number }}
          path: drift-results.json
          retention-days: 30

      - name: Create or update issue
        if: failure() || steps.scan.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read scan results
            let results;
            try {
              results = JSON.parse(fs.readFileSync('drift-results.json', 'utf8'));
            } catch (e) {
              console.log('Could not parse results file');
              return;
            }

            const reposWithIssues = results.repos?.filter(r =>
              r.results?.summary?.integrityFailed > 0 ||
              r.results?.summary?.scansFailed > 0
            ) || [];

            if (reposWithIssues.length === 0) {
              console.log('No issues to report');
              return;
            }

            // Build issue body
            let body = `## Drift Scan Results\n\n`;
            body += `**Scan Date:** ${new Date().toISOString().split('T')[0]}\n`;
            body += `**Repos Scanned:** ${results.summary?.reposScanned || 0}\n`;
            body += `**Repos with Issues:** ${reposWithIssues.length}\n\n`;
            body += `---\n\n`;

            for (const repo of reposWithIssues.slice(0, 10)) {
              body += `### ${repo.repo}\n\n`;

              // Integrity issues
              const integrityIssues = repo.results?.integrity?.filter(i =>
                i.status === 'drift' || i.status === 'missing'
              ) || [];

              if (integrityIssues.length > 0) {
                body += `**Integrity Issues:**\n`;
                for (const issue of integrityIssues) {
                  const icon = issue.status === 'drift' ? 'ðŸ”„' : 'âŒ';
                  body += `- ${icon} \`${issue.file}\` - ${issue.status} (${issue.severity})\n`;
                }
                body += `\n`;
              }

              // Scan failures
              const scanFailures = repo.results?.scans?.filter(s => s.status === 'fail') || [];

              if (scanFailures.length > 0) {
                body += `**Failed Scans:**\n`;
                for (const scan of scanFailures) {
                  body += `- âŒ \`${scan.scan}\`\n`;
                }
                body += `\n`;
              }

              body += `---\n\n`;
            }

            if (reposWithIssues.length > 10) {
              body += `\n*...and ${reposWithIssues.length - 10} more repos with issues.*\n`;
            }

            body += `\n\n[View full results](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;

            // Find existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-scan'
            });

            const existingIssue = issues.data.find(i => i.title === 'Drift Detected');

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Drift Detected',
                body: body,
                labels: ['drift-scan']
              });
              console.log('Created new drift issue');
            }

      - name: Close issue if no drift
        if: success() && steps.scan.outputs.has_issues == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-scan'
            });

            const existingIssue = issues.data.find(i => i.title === 'Drift Detected');

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: 'âœ… All drift issues have been resolved! Closing this issue.'
              });

              console.log(`Closed issue #${existingIssue.number}`);
            }
