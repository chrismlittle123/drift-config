# Drift Configuration for chrismlittle123
# This config enforces coding standards across all repositories

# Repositories to exclude from scanning
exclude:
  - "drift-config" # This repo
  - "chrismlittle123" # Profile README repo
  - "*-template" # Template repos
  - "*.github.io" # GitHub Pages repos

integrity:
  # ===========================================
  # DISCOVER FILES (no strict enforcement)
  # ===========================================
  discover:
    # Find workflow files for visibility
    - pattern: ".github/workflows/*.yml"
      suggestion: "Workflow file detected - ensure it follows security best practices"

    # Find config files that might need standardizing
    - pattern: "*.config.js"
      suggestion: "Config file detected - consider aligning with org standards"

    - pattern: "*.config.ts"
      suggestion: "Config file detected - consider aligning with org standards"

# ===========================================
# SCANS - Security, Required Files, Tooling
# ===========================================
scans:
  # --- Security Scans (relaxed) ---
  - name: npm-audit
    command: npm audit --audit-level=high 2>/dev/null || true
    if: package-lock.json
    timeout: 120

  # Only flag obvious hardcoded secrets (API keys, passwords with values)
  - name: no-hardcoded-secrets
    command: |
      ! grep -rn \
        -e "api[_-]*key\s*[:=]\s*['\"][A-Za-z0-9_-]\{20,\}['\"]" \
        -e "password\s*[:=]\s*['\"][^'\"]\{8,\}['\"]" \
        -e "secret\s*[:=]\s*['\"][A-Za-z0-9_-]\{20,\}['\"]" \
        --include="*.ts" --include="*.js" --include="*.json" --include="*.yaml" --include="*.yml" \
        --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.git \
        --exclude="package-lock.json" --exclude="*.test.*" \
        . 2>/dev/null | grep -v "process\.env" | grep -v "\$\{" | grep -v "secrets\." | head -3
    timeout: 30

  - name: no-env-files-committed
    command: |
      ! ls .env .env.local .env.production .env.*.local 2>/dev/null | grep -q .
    timeout: 10

  # --- Required Files ---
  - name: has-readme
    command: test -f README.md

  - name: has-license
    command: test -f LICENSE || test -f LICENSE.md || test -f LICENSE.txt

  - name: has-gitignore
    command: test -f .gitignore

  # --- TypeScript Project Standards ---
  - name: has-typescript-config
    command: test -f tsconfig.json
    if: package.json

  - name: has-linting
    command: |
      test -f eslint.config.js || test -f .eslintrc.js || test -f .eslintrc.json || \
      test -f .eslintrc || test -f biome.json || test -f deno.json
    if: package.json

  - name: has-formatting
    command: |
      test -f .prettierrc || test -f .prettierrc.json || test -f prettier.config.js || \
      test -f .prettierrc.js || test -f biome.json || test -f deno.json
    if: package.json

  # --- Package.json Checks ---
  - name: has-package-lock
    command: test -f package-lock.json || test -f yarn.lock || test -f pnpm-lock.yaml || test -f bun.lockb
    if: package.json

  - name: no-critical-vulnerabilities
    command: |
      if [ -f package-lock.json ]; then
        CRITICAL=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.critical // 0')
        if [ "$CRITICAL" -gt 0 ]; then
          echo "Found $CRITICAL critical vulnerabilities"
          exit 1
        fi
      fi
      echo "No critical vulnerabilities"
    if: package-lock.json
    timeout: 120

  # --- Python Project Standards ---
  - name: has-python-deps
    command: test -f requirements.txt || test -f pyproject.toml || test -f setup.py || test -f Pipfile
    if: "*.py"

  # --- Terraform Standards ---
  - name: terraform-fmt-check
    command: terraform fmt -check -recursive 2>/dev/null || echo "terraform not installed or no tf files"
    if: "*.tf"
    timeout: 60
